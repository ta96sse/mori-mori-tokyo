name: Deploy with GSS Data

on:
  # 1. GASã‹ã‚‰ã€Œæ›´æ–°ã—ã¦ï¼ã€ã¨è¨€ã‚ã‚ŒãŸã‚‰å‹•ã
  repository_dispatch:
    types: [update-gss-data]
  
  # 2. mainãƒ–ãƒ©ãƒ³ãƒã«ã‚³ãƒ¼ãƒ‰ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ãŸæ™‚ã‚‚å‹•ã
  push:
    branches:
      - main
  
  # 3. GitHubç”»é¢ã‹ã‚‰æ‰‹å‹•ã§ã‚‚å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4

      - name: Setup Node.js âš™ï¸
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Dependencies ğŸ”§
        run: npm ci
        # ã‚‚ã—yarnä½¿ã£ã¦ã‚‹ãªã‚‰ run: yarn install --frozen-lockfile

      # ã€é‡è¦ã€‘ã“ã“ã§GSSãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
      # â€» scripts/fetch-data.js ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ã¦ãŠãå‰æ
      - name: Fetch Data from GSS ğŸ“Š
        env:
          # GSSã®èªè¨¼æƒ…å ±ã¯GitHubã®Secretsã«éš ã—ã¦æ¸¡ã™
          GOOGLE_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          SHEET_ID: ${{ secrets.SPREADSHEET_ID }}
        run: node scripts/fetch-data.js

      - name: Build ğŸ—ï¸
        run: npm run build
        # package.jsonã® build ã‚³ãƒãƒ³ãƒ‰ãŒèµ°ã‚‹

      - name: Deploy to GitHub Pages ğŸš€
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build 
          # â†‘ Viteãªã‚‰ ./distã€Next.js(SSG)ãªã‚‰ ./out ã«æ›¸ãæ›ãˆã¦